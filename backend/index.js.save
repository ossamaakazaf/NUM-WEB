// backend/index.js
const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '..', '.env') });

const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const morgan = require('morgan');
const { celebrate, Joi, errors: celebrateErrors } = require('celebrate');

const app = express();
const PORT = Number(process.env.PORT || 5555);

// Sécurité & middlewares
app.use(helmet());
app.use(morgan('dev'));

const allowed = ['http://localhost:3000']; // ajoute ton domaine prod plus tard
onst allowed = ['http://localhost:3000']; // ajoute ton domaine prod plus tard
app.use(
  cors({
    origin: (origin, cb) => cb(null, !origin || allowed.includes(origin)),
    credentials: true,
  })
);app.use(
  cors({
    origin: (origin, cb) => cb(null, !origin || allowed.includes(origin)),
    credentials: true,
  })
);

app.use(express.json({ limit: '1mb' }));
app.use(
  rateLimit({
    windowMs: 60_000,
    max: 120,
    standardHeaders: true,
    legacyHeaders: false,
  })
);

// ROUTES
app.get('/health', (_req, res) => {
  res.json({ status: 'ok', time: new Date().toISOString() });
});

app.get('/', (_req, res) => {
  res.send('Backend NUMÉWEB opérationnel');
});

app.post(
  '/api/v1/subscribe',
  celebrate({ body: Joi.object({ email: Joi.string().email().required() }) }),
  (req, res) => {
    // TODO: enregistrer l'email en base
    res.status(201).json({ ok: true, email: req.body.email });
  }
);

// celebrate errors AVANT le 404
app.use(celebrateErrors());

// 404 à la fin
app.use((_req, res) => res.status(404).json({ error: 'Not found' }));

app.listen(PORT, () => {
  console.log(`Serveur NUMÉWEB lancé sur http://localhost:${PORT}`);
});

